from sqlalchemy import (Column, Date, Float, ForeignKey, Integer, LargeBinary,
                        String, Unicode, UnicodeText)
from sqlalchemy.ext.associationproxy import association_proxy
from sqlalchemy.orm import declarative_base, relationship, validates
from sqlalchemy.orm.collections import attribute_mapped_collection

Base = declarative_base()


class ProxiedDictMixin:
    """Adds obj[key] access to a mapped class.

    This class basically proxies dictionary access to an attribute
    called ``_proxied``.  The class which inherits this class
    should have an attribute called ``_proxied`` which points to a dictionary.

    From: https://docs.sqlalchemy.org/en/14/_modules/examples/vertical/dictlike.html
    """
    _proxied = None

    def __len__(self):
        return len(self._proxied)

    def __iter__(self):
        return iter(self._proxied)

    def __getitem__(self, key):
        return self._proxied[key]

    def __contains__(self, key):
        return key in self._proxied

    def __setitem__(self, key, value):
        self._proxied[key] = value

    def __delitem__(self, key):
        del self._proxied[key]


def get_csv_headers(clazz: Base):
    """gets the name of all non-binary columns"""
    for column in clazz.__table__.c.keys():
        if not isinstance(clazz.__table__.c[column].type, LargeBinary):
            yield column


def get_csv_row(instance: Base):
    """get the value of all non-binary columns for this instance"""
    for column in instance.__table__.c.keys():
        if not isinstance(instance.__table__.c[column].type, LargeBinary):
            yield getattr(instance, column)


class ModelMixin:
    def to_dict(self):
        return {f'{self.__tablename__}.{c.name}': getattr(self, c.name) for c in self.__table__.columns}


class Study(Base, ModelMixin):
    __tablename__ = 'study'

    id = Column(Integer, primary_key=True)
    title = Column(String)
    authors = Column(String, nullable=False)
    date_input = Column(Date)
    added_by = Column(String)
    uploaded_file = Column(LargeBinary)

    groups = relationship("Group", back_populates="study", cascade="all, delete-orphan")

    def __repr__(self):
        return f"Study(id={self.id}, title={self.title}, authors={self.authors}, added_by={self.added_by}, groups=[\n  " + '\n  '.join(str(g) for g in self.groups) + "\n)"

    @validates('title')
    def validate_study_name(self, key, value):
        # key, value are the name of the variable and the value it takes
        if not isinstance(value, str):
            raise TypeError(f"Failed study_name validation: {key} {value}")
        return value


class Group(Base, ModelMixin):
    __tablename__ = 'group'

    id = Column(Integer, primary_key=True)
    study_id = Column(Integer, ForeignKey(f'{Study.__tablename__}.id'), nullable=False)
    model = Column(String)
    duration = Column(String)
    protein_treatment = Column(String)
    additional_suplementation = Column(String)

    # Add relationship between study and experiment
    study = relationship("Study", back_populates='groups')
    biological_replicas = relationship("Biological_replica", back_populates='group', cascade="all, delete-orphan")

    def __repr__(self):
        return f"Group(model_injury={self.model_injury}, " \
               f"duration={self.duration}, " \
               f"biological_replicas=[\n    " + '\n    '.join(str(a) for a in self.biological_replicas) + "\n  ])"


class Biological_replica(Base, ModelMixin):
    __tablename__ = 'biological_replica'

    id = Column(Integer, primary_key=True)
    group_id = Column(Integer, ForeignKey(f'{Group.__tablename__}.id'), nullable=False)
    cell_name = Column(String)
    cell_origin = Column(String)
    receptor_expression = Column(String)
    media_composition = Column(String)
    passage_number = Column(Integer)
    morphology = Column(String)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
    patient_characteristics = Column(String) 
    no_of_tests = Column(Integer)

    # Add relationship between study and experiment
    group = relationship("Group", back_populates='biological_replicas')
    measurements = relationship("Measurement", back_populates='biological_replica', cascade="all, delete-orphan")

    def __repr__(self):
        return f"""Biological_replicas(cell_name={self.cell_name},
        cell_origin={self.cell_origin},
        receptor_expression={self.receptor_expression},
        morphology={self.morphology},
        measurements=[\n      """ + '\n      '.join(str(m) for m in self.measurements) + "\n    ])"

class Measurement(ProxiedDictMixin, Base):
    __tablename__ = 'measurement'

    id = Column(Integer, primary_key=True)
    biological_replica_id = Column(Integer, ForeignKey(f'{Biological_replica.__tablename__}.id'), nullable=False)
    method = Column(String)
    time_point = Column(String)
    measurement = Column(String)
    value = Column(Float)
    unit = Column(String)
    test_type = Column(String)
    notes = Column(String)

    # Add relationship between study and experiment
    biological_replica = relationship("Biological_replica", back_populates='measurements')
    data = relationship("MeasurementData", collection_class=attribute_mapped_collection("key"),  cascade="all, delete-orphan")

    _proxied = association_proxy("data", "datum", creator=lambda key, datum: MeasurementData(key=key, datum=datum))

    def to_dict(self):
        """We implement a custom to_dict which adds the extra measurement data"""
        measurement_dict = {f'{self.__tablename__}.{c.name}': getattr(self, c.name) for c in self.__table__.columns}
        measurement_dict['measurement.data'] = self.data
        return measurement_dict

    def __repr__(self):
        return f"Measurement(method={self.method}, " \
               f"time_point={self.time_point}, " \
               f"value={self.value}, " \
               f"data=[" + ','.join(str(md) + f"={self[str(md)]}" for md in self.data) + "])"


class MeasurementData(Base):
    __tablename__ = "measurement_data"

    measurement_id = Column(ForeignKey(f"{Measurement.__tablename__}.id"), primary_key=True)
    key = Column(Unicode(64), primary_key=True)
    datum = Column(UnicodeText)

    def __repr__(self):
        return f"{self.datum}"
